{% extends "base.html" %}
{% load bookings %}

{% block content %}
<h2>Events</h2>
<ul>
    {% for event in events %}
        <li>
            <strong>{{ event.title }}</strong> - {{ event.date }} at {{ event.location }}
            <p>{{ event.description }}</p>
            <p>Participants: 
                {% for participant in event.participants.all %}
                    {{ participant.username }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                    No participants yet.
                {% endfor %}
            </p>

            {% if user.is_authenticated %}
                <form method="post" action="{% url 'event_rsvp' event.id %}">
                    {% csrf_token %}
                    {% with user|bookings:event as booking %}
                        {% if booking and booking.status == 'confirmed' %}
                            <input type="hidden" name="action" value="cancel">
                            <button type="submit">Cancel RSVP</button>
                            <p>Status: Confirmed</p>
                        {% else %}
                            <input type="hidden" name="action" value="join">
                            <button type="submit">Join Event</button>
                            <p>Status: Not Joined</p>
                        {% endif %}
                    {% endwith %}
                </form>
            {% else %}
                <p><a href="{% url 'login' %}">Login</a> to RSVP for events.</p>
            {% endif %}
        </li>
    {% empty %}
        <p>No events available.</p>
    {% endfor %}
</ul>
<a href="{% url 'event_create' %}">Create Event</a>
{% endblock %}
